/**
Â * Google Apps Script for WhatsApp Glass Bot Integration
Â *
Â * This script creates a Web App that handles sync requests from your WhatsApp bot.
Â * Deploy this as a Web App in Google Apps Script.
Â */

// Configuration - Update these values after creating your spreadsheet
const SPREADSHEET_ID = '17oU0xbq1glbYgS6B_tBAcWMop65FzCUj32_583EEjEY'; // <<<<< YOUR SPREADSHEET ID IS HERE
const DEFAULT_SHEET_NAME = 'Pending'; // New orders from bot will land here
const SHEET_NAMES = ['Pending', 'Ready', 'Delivered', 'Completed']; // All relevant sheet names for order flow

// Column mapping (consistent across sheets)
const COLUMNS = {
Â  ID: 0,
Â  CLIENT_NAME: 1,
Â  SPECIFICATIONS: 2,
Â  SIZES: 3,
Â  QUANTITY: 4,
Â  STATUS: 5, // This is the column where the dropdown will be
Â  NOTES: 6,
Â  CREATED_AT: 7,
Â  UPDATED_AT: 8,
Â  SYNC_STATUS: 9
};
const HEADERS = [
Â  'ID',
Â  'Client Name',
Â  'Specifications',
Â  'Sizes',
Â  'Quantity',
Â  'Status',
Â  'Notes',
Â  'Created At',
Â  'Updated At',
Â  'Sync Status'
];
/**
Â * Main function that handles all Web App requests
Â * This is the entry point for POST requests from your WhatsApp bot/dashboard.
Â */
function doPost(e) {
Â  try {
Â  Â  if (!e || !e.postData || !e.postData.contents) {
Â  Â  Â  Logger.log('Error: No postData found in request');
Â  Â  Â  return createResponse(false, 'No data received in request');
Â  Â  }

Â  Â  const requestData = JSON.parse(e.postData.contents);
Â  Â  const action = requestData.action || '';
Â  Â  const data = requestData.data || {};
Â  Â  
Â  Â  const normalizedAction = action.toLowerCase();
Â  Â  Logger.log('Received normalized request: ' + normalizedAction);

Â  Â  switch (normalizedAction) {
Â  Â  Â  case 'test':
Â  Â  Â  Â  return createResponse(true, 'Connection successful');
Â  Â  Â  case 'synctosheets':
Â  Â  Â  Â  var targetSheet = data.targetSheetName || DEFAULT_SHEET_NAME;
Â  Â  Â  Â  return syncOrdersToSheet(data.orders, targetSheet);
Â  Â  Â  case 'getorders':
Â  Â  Â  Â  return getOrdersFromSheet(DEFAULT_SHEET_NAME);
Â  Â  Â  case 'getordersfromsheet':
Â  Â  Â  Â  const sheetName = data.sheetName || DEFAULT_SHEET_NAME;
Â  Â  Â  Â  return getOrdersFromSheet(sheetName);
Â  Â  Â  case 'getrawsheetdata':
Â  Â  Â  Â  const rawSheetName = data.sheetName || DEFAULT_SHEET_NAME;
Â  Â  Â  Â  return getRawSheetData(rawSheetName);
Â  Â  Â  case 'createspreadsheet':
Â  Â  Â  Â  return createNewSpreadsheet(data.title);
Â  Â  Â  case 'updateorderstatusandmove':
Â  Â  Â  Â  return handleExternalStatusUpdateAndMove(data.orderId, data.newStatus);
Â  Â  Â  default:
Â  Â  Â  Â  return createResponse(false, 'Unknown action: ' + action);
Â  Â  }
Â  } catch (error) {
Â  Â  Logger.log('Error in doPost: ' + error.toString());
Â  Â  return createResponse(false, 'Server error: ' + error.toString());
Â  }
}

/**
Â * Handle GET requests (for testing and simple actions)
Â */
function doGet(e) {
Â  try {
Â  Â  if (e && e.parameter && e.parameter.action) {
Â  Â  Â  const action = e.parameter.action;
Â  Â  Â  const normalizedAction = action.toLowerCase();
Â  Â  Â  Logger.log('GET request with normalized action: ' + normalizedAction);

Â  Â  Â  switch (normalizedAction) {
Â  Â  Â  Â  case 'test':
Â  Â  Â  Â  Â  return createResponse(true, 'Connection successful via GET');
Â  Â  Â  Â  case 'getorders':
Â  Â  Â  Â  Â  return getOrdersFromSheet(DEFAULT_SHEET_NAME);
Â  Â  Â  Â  case 'getordersfromsheet':
Â  Â  Â  Â  Â  const sheetName = e.parameter.sheetName || DEFAULT_SHEET_NAME;
Â  Â  Â  Â  Â  return getOrdersFromSheet(sheetName);
Â  Â  Â  Â  case 'getrawsheetdata':
Â  Â  Â  Â  Â  const rawSheetName = e.parameter.sheetName || DEFAULT_SHEET_NAME;
Â  Â  Â  Â  Â  return getRawSheetData(rawSheetName);
Â  Â  Â  Â  default:
Â  Â  Â  Â  Â  return createResponse(false, 'Unknown GET action: ' + action);
Â  Â  Â  }
Â  Â  }
Â  Â  return ContentService
Â  Â  Â  .createTextOutput('WhatsApp Glass Bot Apps Script is running!')
Â  Â  Â  .setMimeType(ContentService.MimeType.TEXT);
Â  } catch (error) {
Â  Â  Logger.log('Error in doGet: ' + error.toString());
Â  Â  return createResponse(false, 'GET error: ' + error.toString());
Â  }
}

/**
Â * Creates a standardized JSON response for the Web App.
Â */
function createResponse(success, message, data = null) {
Â  const response = {
Â  Â  success: success,
Â  Â  message: message,
Â  Â  data: data,
Â  Â  timestamp: new Date().toISOString()
Â  };
Â  return ContentService
Â  Â  .createTextOutput(JSON.stringify(response))
Â  Â  .setMimeType(ContentService.MimeType.JSON);
}

/**
Â * Gets the specified spreadsheet by ID and ensures all required sheets exist and are set up.
Â */
function getSpreadsheet(sheetName = DEFAULT_SHEET_NAME) {
Â  try {
Â  Â  const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
Â  Â  SHEET_NAMES.forEach(name => {
Â  Â  Â  let sheet = spreadsheet.getSheetByName(name);
Â  Â  Â  if (!sheet) {
Â  Â  Â  Â  sheet = spreadsheet.insertSheet(name);
Â  Â  Â  Â  setupSheet(sheet);
Â  Â  Â  } else {
Â  Â  Â  Â  setupSheet(sheet);
Â  Â  Â  }
Â  Â  });
Â  Â  const targetSheet = spreadsheet.getSheetByName(sheetName);
Â  Â  if (!targetSheet) {
Â  Â  Â  throw new Error(`Sheet '${sheetName}' not found or could not be created.`);
Â  Â  }
Â  Â  return targetSheet;
Â  } catch (error) {
Â  Â  Logger.log('Error getting spreadsheet or sheet: ' + error.toString());
Â  Â  throw error;
Â  }
}

/**
Â * Sets up a given sheet with headers, formatting, column widths, frozen rows, etc.
Â */
function setupSheet(sheet) {
Â  if (sheet.getRange(1, 1).getValue() !== HEADERS[0]) {
Â  Â  sheet.getRange(1, 1, 1, HEADERS.length).setValues([HEADERS]);
Â  Â  const headerRange = sheet.getRange(1, 1, 1, HEADERS.length);
Â  Â  headerRange.setBackground('#4285f4').setFontColor('white').setFontWeight('bold');
Â  }
Â  sheet.setColumnWidth(1, 100).setColumnWidth(2, 200).setColumnWidth(3, 300)
Â  Â  Â  Â .setColumnWidth(4, 150).setColumnWidth(5, 80).setColumnWidth(6, 100)
Â  Â  Â  Â .setColumnWidth(7, 200).setColumnWidth(8, 150).setColumnWidth(9, 150)
Â  Â  Â  Â .setColumnWidth(10, 100);
Â  sheet.setFrozenRows(1);
Â  const statusColumnIndex = COLUMNS.STATUS + 1;
Â  const rules = SpreadsheetApp.newDataValidation()
Â  Â  .requireValueInList(['Pending', 'Ready', 'Delivered', 'Completed'])
Â  Â  .setAllowInvalid(false).build();
Â  sheet.getRange(2, statusColumnIndex, sheet.getMaxRows() - 1).setDataValidation(rules);
}

/**
Â * Syncs order line items from the bot to a specified spreadsheet tab and adds a blank row after.
Â */
function syncOrdersToSheet(orders, targetSheetName) {
Â  try {
Â  Â  const sheet = getSpreadsheet(targetSheetName);
Â  Â  if (!orders || orders.length === 0) {
Â  Â  Â  return createResponse(true, 'No orders to sync');
Â  Â  }
Â  Â  const rowsToAppend = orders.map(order => [
Â  Â  Â  order.id || '', order.clientName || '', order.specifications || '',
Â  Â  Â  order.sizes || '', order.quantity || 0, order.status || 'Pending',
Â  Â  Â  order.notes || '', order.createdAt || '', order.updatedAt || '', 'synced'
Â  Â  ]);

    // Create an empty row with the same number of columns as your headers
    const emptyRow = [Array(HEADERS.length).fill('')];

    // Combine the order rows with the empty row
    const finalRowsToWrite = rowsToAppend.concat(emptyRow);

Â  Â  if (rowsToAppend.length > 0) {
      // Check if the last row is a header row or has content, to avoid double spacing
      const lastRow = sheet.getLastRow();
      let startRow = lastRow + 1;
      if (lastRow > 1 && sheet.getRange(lastRow, 1, 1, sheet.getLastColumn()).getValues()[0].every(cell => cell === '')) {
        // If the last row is already blank, start writing on that row instead of adding another space
        startRow = lastRow;
      }

Â  Â  Â  sheet.getRange(startRow, 1, finalRowsToWrite.length, HEADERS.length).setValues(finalRowsToWrite);
      // We only apply the dropdown validation to the actual order rows, not the blank one.
Â  Â  Â  applyStatusDropdownToOrderIDs(sheet, startRow, rowsToAppend.length);
Â  Â  }
Â  Â  return createResponse(true, `Synced ${orders.length} order line items to spreadsheet: ${targetSheetName}`);
Â  } catch (error) {
Â  Â  return createResponse(false, `Error syncing to sheet: ${error.toString()}`);
Â  }
}


/**
Â * Retrieves and structures order data from a specified spreadsheet tab.
Â */
function getOrdersFromSheet(sheetName) {
Â  try {
Â  Â  const sheet = getSpreadsheet(sheetName);
Â  Â  const lastRow = sheet.getLastRow();
Â  Â  if (lastRow <= 1) {
Â  Â  Â  return createResponse(true, `No orders found in ${sheetName}`, []);
Â  Â  }

Â  Â  const range = sheet.getRange(2, 1, lastRow - 1, HEADERS.length);
Â  Â  const data = range.getValues().filter(row => row.some(cell => cell !== ''));

Â  Â  const allOrders = [];
Â  Â  let currentOrder = null;

Â  Â  for (const row of data) {
Â  Â  Â  const orderId = row[COLUMNS.ID];
Â  Â  Â  const sizes = row[COLUMNS.SIZES];
Â  Â  Â  const quantity = row[COLUMNS.QUANTITY];

Â  Â  Â  if (orderId) {
Â  Â  Â  Â  if (currentOrder) {
Â  Â  Â  Â  Â  allOrders.push(currentOrder);
Â  Â  Â  Â  }
Â  Â  Â  Â  currentOrder = {
Â  Â  Â  Â  Â  id: orderId,
Â  Â  Â  Â  Â  clientName: row[COLUMNS.CLIENT_NAME] || '',
Â  Â  Â  Â  Â  specifications: row[COLUMNS.SPECIFICATIONS] || '',
Â  Â  Â  Â  Â  items: [{ sizes: sizes || '', quantity: quantity || 0 }],
Â  Â  Â  Â  Â  status: row[COLUMNS.STATUS] || 'Pending',
Â  Â  Â  Â  Â  notes: row[COLUMNS.NOTES] || '',
Â  Â  Â  Â  Â  createdAt: row[COLUMNS.CREATED_AT] || '',
Â  Â  Â  Â  Â  updatedAt: row[COLUMNS.UPDATED_AT] || ''
Â  Â  Â  Â  };
Â  Â  Â  } else {
Â  Â  Â  Â  if (currentOrder) {
Â  Â  Â  Â  Â  currentOrder.items.push({
Â  Â  Â  Â  Â  Â  sizes: sizes || '',
Â  Â  Â  Â  Â  Â  quantity: quantity || 0
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }

Â  Â  if (currentOrder) {
Â  Â  Â  allOrders.push(currentOrder);
Â  Â  }

Â  Â  Logger.log(`Retrieved ${allOrders.length} structured orders from ${sheetName} sheet`);
Â  Â  return createResponse(true, `Retrieved ${allOrders.length} orders from ${sheetName}`, allOrders);
Â  } catch (error) {
Â  Â  Logger.log(`Error getting orders from sheet (${sheetName}): ${error.toString()}`);
Â  Â  return createResponse(false, `Error getting orders: ${error.toString()}`);
Â  }
}

/**
Â * Retrieves ALL raw data from a specified spreadsheet tab.
Â */
function getRawSheetData(sheetName) {
Â  try {
Â  Â  const sheet = getSpreadsheet(sheetName);
Â  Â  const lastRow = sheet.getLastRow();
Â  Â  if (lastRow <= 1) {
Â  Â  Â  return createResponse(true, `No data found in ${sheetName}`, []);
Â  Â  }
Â  Â  const data = sheet.getRange(1, 1, lastRow, HEADERS.length).getValues();
Â  Â  return createResponse(true, `Retrieved raw data from ${sheetName}`, data);
Â  } catch (error) {
Â  Â  return createResponse(false, `Error getting raw data: ${error.toString()}`);
Â  }
}

/**
Â * Handles status updates and order movement when triggered by external POST requests.
Â */
function handleExternalStatusUpdateAndMove(orderId, newStatus) {
Â  try {
Â  Â  const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
Â  Â  let orderRows = [];
Â  Â  let sourceSheet = null;
Â  Â  let startRowIndexInSourceData = -1;
Â  Â  const normalizedNewStatus = newStatus.charAt(0).toUpperCase() + newStatus.slice(1).toLowerCase();

Â  Â  if (!SHEET_NAMES.includes(normalizedNewStatus)) {
Â  Â  Â  return createResponse(false, `Invalid status: '${newStatus}'. Must be one of ${SHEET_NAMES.join(', ')}.`);
Â  Â  }

Â  Â  for (const sheetName of SHEET_NAMES) {
Â  Â  Â  const sheet = spreadsheet.getSheetByName(sheetName);
Â  Â  Â  if (!sheet || sheet.getLastRow() <= 1) continue;
Â  Â  Â  const sheetData = sheet.getRange(2, 1, sheet.getLastRow() - 1, HEADERS.length).getValues();
Â  Â  Â  for (let i = 0; i < sheetData.length; i++) {
Â  Â  Â  Â  if (String(sheetData[i][COLUMNS.ID]).trim() === String(orderId).trim()) {
Â  Â  Â  Â  Â  sourceSheet = sheet;
Â  Â  Â  Â  Â  startRowIndexInSourceData = i;
Â  Â  Â  Â  Â  while (i < sheetData.length && (String(sheetData[i][COLUMNS.ID]).trim() === String(orderId).trim() || sheetData[i][COLUMNS.ID] === '')) {
Â  Â  Â  Â  Â  Â  orderRows.push(sheetData[i]);
Â  Â  Â  Â  Â  Â  i++;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  if (orderRows.length > 0) break;
Â  Â  }

Â  Â  if (orderRows.length === 0) {
Â  Â  Â  return createResponse(false, `Order with ID ${orderId} not found in any sheet.`);
Â  Â  }

Â  Â  const formattedTimestamp = Utilities.formatDate(new Date(), SpreadsheetApp.getActiveSpreadsheet().getSpreadsheetTimeZone(), "yyyy-MM-dd HH:mm:ss");
Â  Â  orderRows.forEach(row => {
Â  Â  Â  row[COLUMNS.STATUS] = normalizedNewStatus;
Â  Â  Â  row[COLUMNS.UPDATED_AT] = formattedTimestamp;
Â  Â  });

Â  Â  const targetSheet = getSpreadsheet(normalizedNewStatus);
Â  Â  targetSheet.getRange(targetSheet.getLastRow() + 1, 1, orderRows.length, HEADERS.length).setValues(orderRows);
Â  Â  applyStatusDropdownToOrderIDs(targetSheet, targetSheet.getLastRow() - orderRows.length + 1, 1);
Â  Â  sourceSheet.deleteRows(startRowIndexInSourceData + 2, orderRows.length);

Â  Â  return createResponse(true, `Order ${orderId} updated status to ${newStatus} and moved to ${targetSheet.getName()} sheet.`);
Â  } catch (error) {
Â  Â  return createResponse(false, `Error updating status and moving order: ${error.toString()}`);
Â  }
}

/**
Â * **Google Apps Script OnEdit Trigger Function**
Â */
function onEdit(e) {
Â  const range = e.range;
Â  const sheet = range.getSheet();
Â  const editedColumn = range.getColumn();
Â  const editedRow = range.getRow();

Â  if (editedRow > 1 && editedColumn === (COLUMNS.ID + 1)) {
Â  Â  applyStatusDropdownToOrderIDs(sheet, editedRow, 1);
Â  }

Â  if (editedRow > 1 && editedColumn === (COLUMNS.STATUS + 1)) {
Â  Â  const orderId = sheet.getRange(editedRow, COLUMNS.ID + 1).getValue();
Â  Â  if (orderId) {
Â  Â  Â  const newValue = e.value;
Â  Â  Â  const normalizedNewValue = newValue.charAt(0).toUpperCase() + newValue.slice(1).toLowerCase();
Â  Â  Â  if (SHEET_NAMES.includes(normalizedNewValue)) {
Â  Â  Â  Â  moveOrderBetweenSheets(sheet, orderId, normalizedNewValue, editedRow);
Â  Â  Â  } else {
Â  Â  Â  Â  range.setValue(e.oldValue);
Â  Â  Â  Â  SpreadsheetApp.getUi().alert('Invalid Status', `The status '${newValue}' is not valid.`);
Â  Â  Â  }
Â  Â  } else {
Â  Â  Â  range.clearDataValidations();
Â  Â  Â  if (e.value) {
Â  Â  Â  Â  range.clearContent();
Â  Â  Â  }
Â  Â  }
Â  }
}

/**
Â * Internal helper function to find all rows associated with an order ID and move them.
Â */
function moveOrderBetweenSheets(sourceSheet, orderId, newStatus, editedRow) {
Â  try {
Â  Â  const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
Â  Â  const targetSheet = getSpreadsheet(newStatus);
Â  Â  const sourceSheetData = sourceSheet.getDataRange().getValues();
Â  Â  let orderRowsToMove = [];
Â  Â  let firstOrderRowIndexInSheet = -1;

Â  Â  for (let i = editedRow; i >= 2; i--) {
Â  Â  Â  if (sourceSheetData[i - 1] && String(sourceSheetData[i - 1][COLUMNS.ID]).trim() === String(orderId).trim()) {
Â  Â  Â  Â  firstOrderRowIndexInSheet = i;
Â  Â  Â  Â  break;
Â  Â  Â  }
Â  Â  }

Â  Â  if (firstOrderRowIndexInSheet === -1) return;

Â  Â  const formattedTimestamp = Utilities.formatDate(new Date(), spreadsheet.getSpreadsheetTimeZone(), "yyyy-MM-dd HH:mm:ss");
Â  Â  let currentRowInSheet = firstOrderRowIndexInSheet;
Â  Â  while (currentRowInSheet <= sourceSheet.getLastRow()) {
Â  Â  Â  const rowData = sourceSheetData[currentRowInSheet - 1];
Â  Â  Â  if (rowData && (String(rowData[COLUMNS.ID]).trim() === String(orderId).trim() || (rowData[COLUMNS.ID] === '' && orderRowsToMove.length > 0))) {
Â  Â  Â  Â  rowData[COLUMNS.STATUS] = newStatus;
Â  Â  Â  Â  rowData[COLUMNS.UPDATED_AT] = formattedTimestamp;
Â  Â  Â  Â  orderRowsToMove.push(rowData);
Â  Â  Â  Â  currentRowInSheet++;
Â  Â  Â  } else if (rowData && rowData[COLUMNS.ID] !== '' && orderRowsToMove.length > 0) {
Â  Â  Â  Â  break;
Â  Â  Â  } else {
Â  Â  Â  Â  currentRowInSheet++;
Â  Â  Â  }
Â  Â  }

Â  Â  if (orderRowsToMove.length > 0) {
Â  Â  Â  targetSheet.getRange(targetSheet.getLastRow() + 1, 1, orderRowsToMove.length, HEADERS.length).setValues(orderRowsToMove);
Â  Â  Â  applyStatusDropdownToOrderIDs(targetSheet, targetSheet.getLastRow() - orderRowsToMove.length + 1, 1);
Â  Â  Â  sourceSheet.deleteRows(firstOrderRowIndexInSheet, orderRowsToMove.length);
Â  Â  }
Â  } catch (error) {
Â  Â  SpreadsheetApp.getUi().alert('Error moving order', `An error occurred: ${error.toString()}`);
Â  }
}

/**
Â * Applies or removes data validation (dropdown) for the Status column.
Â */
function applyStatusDropdownToOrderIDs(sheet, startRow, numRows) {
Â  const statusColumnIndex = COLUMNS.STATUS + 1;
Â  const idColumnIndex = COLUMNS.ID + 1;
Â  const rules = SpreadsheetApp.newDataValidation()
Â  Â  .requireValueInList(['Pending', 'Ready', 'Delivered', 'Completed'])
Â  Â  .setAllowInvalid(false).build();

Â  for (let i = 0; i < numRows; i++) {
Â  Â  const currentRow = startRow + i;
Â  Â  const idCell = sheet.getRange(currentRow, idColumnIndex);
Â  Â  const statusCell = sheet.getRange(currentRow, statusColumnIndex);
Â  Â  if (idCell.getValue()) {
Â  Â  Â  statusCell.setDataValidation(rules);
Â  Â  } else {
Â  Â  Â  statusCell.clearDataValidations();
Â  Â  }
Â  }
}

/**
Â * Creates a new spreadsheet with all required tabs and initial setup.
Â */
function createNewSpreadsheet(title) {
Â  try {
Â  Â  const spreadsheet = SpreadsheetApp.create(title || 'WhatsApp Glass Bot Orders');
Â  Â  SHEET_NAMES.forEach(name => {
Â  Â  Â  let sheet = spreadsheet.getSheetByName(name);
Â  Â  Â  if (!sheet) {
Â  Â  Â  Â  sheet = spreadsheet.insertSheet(name);
Â  Â  Â  Â  setupSheet(sheet);
Â  Â  Â  }
Â  Â  });
Â  Â  const defaultSheet = spreadsheet.getSheetByName('Sheet1');
Â  Â  if (defaultSheet && defaultSheet.getLastRow() === 0) {
Â  Â  Â  spreadsheet.deleteSheet(defaultSheet);
Â  Â  }
Â  Â  return createResponse(true, 'Spreadsheet created successfully', {
Â  Â  Â  url: spreadsheet.getUrl(),
Â  Â  Â  id: spreadsheet.getId()
Â  Â  });
Â  } catch (error) {
Â  Â  return createResponse(false, `Error creating spreadsheet: ${error.toString()}`);
Â  }
}

// *** RESTORED UTILITY AND TEST FUNCTIONS ***

/**
Â * Utility function to get spreadsheet info (e.g., URL, ID, name).
Â * @returns {GoogleAppsScript.Content.TextOutput} - A JSON response with spreadsheet information.
Â */
function getSpreadsheetInfo() {
Â  try {
Â  Â  const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID); //
Â  Â  const sheet = spreadsheet.getSheetByName(DEFAULT_SHEET_NAME); //
Â  Â  return createResponse(true, 'Spreadsheet info retrieved', { //
Â  Â  Â  url: spreadsheet.getUrl(), //
Â  Â  Â  id: spreadsheet.getId(), //
Â  Â  Â  name: spreadsheet.getName(), //
Â  Â  Â  lastRow: sheet ? sheet.getLastRow() : 0 //
Â  Â  }); //
Â  } catch (error) {
Â  Â  Logger.log('Error getting spreadsheet info: ' + error.toString()); //
Â  Â  return createResponse(false, 'Error getting spreadsheet info: ' + error.toString()); //
Â  }
}

/**
Â * Test function - You can run this directly from the Apps Script editor
Â * to verify the setup and core functionalities.
Â */
function testSetup() {
Â  try {
Â  Â  Logger.log('Starting Apps Script setup and functionality tests...'); //
Â  Â  // Test spreadsheet access and ensure all required sheets exist
Â  Â  SHEET_NAMES.forEach(name => getSpreadsheet(name)); //
Â  Â  Logger.log('âœ… All sheets accessed/created successfully.'); //

Â  Â  // --- Test: Sync new order with multiple line items to 'Pending' ---
Â  Â  const testOrderId = 'TEST-' + Utilities.getUuid().substring(0, 8).toUpperCase(); //
Â  Â  const testOrderLineItems = [ //
Â  Â  Â  {
Â  Â  Â  Â  id: testOrderId, //
Â  Â  Â  Â  clientName: 'Alpha Customer', //
Â  Â  Â  Â  specifications: '10mm Clear Glass', //
Â  Â  Â  Â  sizes: '2000x1000', //
Â  Â  Â  Â  quantity: 1, //
Â  Â  Â  Â  status: 'Pending', //
Â  Â  Â  Â  notes: 'Test main item', //
Â  Â  Â  Â  createdAt: new Date().toISOString(), //
Â  Â  Â  Â  updatedAt: new Date().toISOString() //
Â  Â 
Â  Â  Â  Â }, //
Â  Â  Â  {
Â  Â  Â  Â  id: '', //
Â  Â  Â  Â  clientName: '', //
Â  Â  Â  Â  specifications: '10mm Clear Glass', //
Â  Â  Â  Â  sizes: '1500x750', //
Â  Â  Â  Â  quantity: 2, //
Â  Â  Â  Â  status: 'Pending', //
Â  Â  Â  Â  notes: 'Sub-item 1', //
Â  Â  Â  Â  createdAt: new Date().toISOString(), //
Â  Â  Â 
Â  Â  Â  Â updatedAt: new Date().toISOString() //
Â  Â  Â  }, //
Â  Â  Â  {
Â  Â  Â  Â  id: '', //
Â  Â  Â  Â  clientName: '', //
Â  Â  Â  Â  specifications: '8mm Frosted Glass', //
Â  Â  Â  Â  sizes: '1200x800', //
Â  Â  Â  Â  quantity: 1, //
Â  Â  Â  Â  status: 'Pending', //
Â  Â  Â  Â  notes: 'Sub-item 2, different spec', //
Â  Â  Â  Â  createdAt: new Date().toISOString(), //
Â  Â  Â 
Â  Â  Â  Â updatedAt: new Date().toISOString() //
Â  Â  Â  } //
Â  Â  ];

Â  Â  syncOrdersToSheet(testOrderLineItems, 'Pending'); //
Â  Â  Logger.log('âœ… Sync to Pending sheet successful with multiple line items for order ID: ' + testOrderId); //
Â  Â  Utilities.sleep(1000); //
Â  Â  // Give time for sheet updates

Â  Â  // --- Test: Retrieve orders from 'Pending' ---
Â  Â  let result = getOrdersFromSheet('Pending'); //
Â  Â  Logger.log('âœ… Get from Pending sheet successful. Orders retrieved: ' + (result.data ? result.data.length : 0)); //
Â  Â  Utilities.sleep(1000); //
Â  Â  // --- Test: Simulate movement from 'Pending' to 'Ready' (as if by external system) ---
Â  Â  Logger.log(`Simulating movement of order ID: ${testOrderId} from Pending to Ready`); //
Â  Â  handleExternalStatusUpdateAndMove(testOrderId, 'Ready'); //
Â  Â  Logger.log('âœ… Simulated movement to Ready successful.'); //
Â  Â  Utilities.sleep(1000); //

Â  Â  // Verify it's no longer in Pending
Â  Â  result = getOrdersFromSheet('Pending'); //
Â  Â  Logger.log('Pending sheet after move (should be less): ' + (result.data ? result.data.length : 0)); //
Â  Â  result = getOrdersFromSheet('Ready'); //
Â  Â  Logger.log('Ready sheet after move (should have new order): ' + (result.data ? result.data.length : 0)); //
Â  Â  Utilities.sleep(1000); //
Â  Â  // --- Test: Simulate movement from 'Ready' to 'Delivered' ---
Â  Â  Logger.log(`Simulating movement of order ID: ${testOrderId} from Ready to Delivered`); //
Â  Â  handleExternalStatusUpdateAndMove(testOrderId, 'Delivered'); //
Â  Â  Logger.log('âœ… Simulated movement to Delivered successful.'); //
Â  Â  Utilities.sleep(1000); //

Â  Â  // --- Test: Simulate movement from 'Delivered' to 'Completed' ---
Â  Â  Logger.log(`Simulating movement of order ID: ${testOrderId} from Delivered to Completed`); //
Â  Â  handleExternalStatusUpdateAndMove(testOrderId, 'Completed'); //
Â  Â  Logger.log('âœ… Simulated movement to Completed successful.'); //
Â  Â  Utilities.sleep(1000); //

Â  Â  // Verify it's in Completed
Â  Â  result = getOrdersFromSheet('Completed'); //
Â  Â  Logger.log('Completed sheet after final move (should have new order): ' + (result.data ? result.data.length : 0)); //
Â  Â  Utilities.sleep(1000); //
Â  Â  Logger.log('ðŸŽ‰ All main tests passed! Apps Script is ready.'); //

Â  } catch (error) {
Â  Â  Logger.log('âŒ Test failed: ' + error.toString()); //
Â  Â  SpreadsheetApp.getUi().alert('Test Failed', 'One or more tests failed. Check the Apps Script logs for details: ' + error.toString(), SpreadsheetApp.getUi().ButtonSet.OK); //
Â  }
}

/**
Â * **Utility Function to Initialize/Update All Sheets**
Â * Run this function once from the Apps Script editor after deploying the code.
Â * It ensures that all tabs ('Pending', 'Ready', 'Delivered', 'Completed') exist
Â * in your Google Sheet, have the correct headers, formatting, frozen rows,
Â * and the 'Status' dropdown with 'Completed' option.
Â */
function initializeSheets() {
Â  try {
Â  Â  SHEET_NAMES.forEach(sheetName => { //
Â  Â  Â  const sheet = getSpreadsheet(sheetName); // This will ensure sheet exists and is set up
Â  Â  Â  Logger.log(`Initialized/Updated sheet: ${sheetName}`); //
Â  Â  }); //
Â  Â  Logger.log('All required sheets initialized/updated with headers, formatting, and validation.'); //
Â  Â  SpreadsheetApp.getUi().alert('Initialization Complete', 'All required sheets have been initialized/updated successfully. Please ensure you have set up the "On edit" trigger if you plan to move orders by changing status in the sheet.', SpreadsheetApp.getUi().ButtonSet.OK); //
Â  } catch (error) {
Â  Â  Logger.log('Error initializing sheets: ' + error.toString()); //
Â  Â  SpreadsheetApp.getUi().alert('Initialization Error', 'An error occurred during initialization: ' + error.toString() + '. Check Apps Script logs for details.', SpreadsheetApp.getUi().ButtonSet.OK); //
Â  }
}